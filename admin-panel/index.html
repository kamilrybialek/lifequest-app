<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeQuest Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #F5F7FA;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .header h1 {
            font-size: 28px;
            color: #58CC02;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* Login */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            margin-bottom: 24px;
            color: #58CC02;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E5E5;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #58CC02;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #58CC02;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #46A302;
        }

        .btn-secondary {
            background: #E5E5E5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #D5D5D5;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 800;
            color: #333;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: #58CC02;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #F5F5F5;
        }

        /* Content sections */
        .content-section {
            display: none;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .content-section.active {
            display: block;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #F5F5F5;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E5E5E5;
        }

        th {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }

        tr:hover {
            background: #F9F9F9;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background: #D4EDDA; color: #155724; }
        .badge-warning { background: #FFF3CD; color: #856404; }
        .badge-info { background: #D1ECF1; color: #0C5460; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: #D32F2F;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2>üîê Admin Login</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="emailInput" placeholder="kamil.rybialek@gmail.com">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <div id="loginError" class="error hidden"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üìä LifeQuest Admin Panel</h1>
                <p>Welcome back, <span id="adminName"></span></p>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="value" id="statTotalUsers">-</div>
                </div>
                <div class="stat-card">
                    <h3>Active Users (7d)</h3>
                    <div class="value" id="statActiveUsers">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Tasks</h3>
                    <div class="value" id="statTotalTasks">-</div>
                </div>
                <div class="stat-card">
                    <h3>Completion Rate</h3>
                    <div class="value" id="statCompletionRate">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('users')">üë• Users</button>
                <button class="tab" onclick="showTab('tasks')">‚úÖ Task Templates</button>
                <button class="tab" onclick="showTab('content')">üìù Content</button>
                <button class="tab" onclick="showTab('notifications')">üîî Notifications</button>
                <button class="tab" onclick="showTab('logs')">üìú Activity Logs</button>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="content-section active">
                <h2>User Management</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Level</th>
                            <th>XP</th>
                            <th>Streaks</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="6" style="text-align:center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Task Templates Section -->
            <div id="tasksSection" class="content-section">
                <h2>Task Templates</h2>
                <button class="btn" onclick="showCreateTaskModal()">+ Create New Task</button>
                <br><br>
                <table>
                    <thead>
                        <tr>
                            <th>Pillar</th>
                            <th>Title</th>
                            <th>Duration</th>
                            <th>XP</th>
                            <th>Difficulty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBody">
                        <tr><td colspan="6" style="text-align:center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Content Section -->
            <div id="contentSection" class="content-section">
                <h2>Content Management</h2>
                <button class="btn" onclick="showCreateContentModal()">+ Create New Content</button>
                <br><br>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Pillar</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="contentTableBody">
                        <tr><td colspan="5" style="text-align:center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Notifications Section -->
            <div id="notificationsSection" class="content-section">
                <h2>Push Notifications</h2>
                <button class="btn" onclick="showCreateNotificationModal()">+ Send Notification</button>
                <br><br>
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Target</th>
                            <th>Status</th>
                            <th>Scheduled</th>
                            <th>Sent</th>
                        </tr>
                    </thead>
                    <tbody id="notificationsTableBody">
                        <tr><td colspan="5" style="text-align:center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Activity Logs Section -->
            <div id="logsSection" class="content-section">
                <h2>Activity Logs</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Target</th>
                            <th>Details</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <tr><td colspan="5" style="text-align:center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <h2>Create Task Template</h2>
            <div class="form-group">
                <label>Pillar</label>
                <select id="taskPillar" style="width:100%; padding:12px; border:2px solid #E5E5E5; border-radius:8px;">
                    <option value="finance">Finance</option>
                    <option value="mental">Mental</option>
                    <option value="physical">Physical</option>
                    <option value="nutrition">Nutrition</option>
                </select>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="taskTitle" placeholder="Track Your Expenses">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="taskDescription" placeholder="Record 3 expenses from today">
            </div>
            <div class="form-group">
                <label>Duration (minutes)</label>
                <input type="number" id="taskDuration" placeholder="5" value="5">
            </div>
            <div class="form-group">
                <label>XP Reward</label>
                <input type="number" id="taskXP" placeholder="10" value="10">
            </div>
            <div class="form-group">
                <label>Difficulty</label>
                <select id="taskDifficulty" style="width:100%; padding:12px; border:2px solid #E5E5E5; border-radius:8px;">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <button class="btn" onclick="createTask()">Create</button>
            <button class="btn btn-secondary" onclick="closeModal('createTaskModal')" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <!-- Create Notification Modal -->
    <div id="createNotificationModal" class="modal">
        <div class="modal-content">
            <h2>Send Push Notification</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="notifTitle" placeholder="New Challenge Available!">
            </div>
            <div class="form-group">
                <label>Body</label>
                <textarea id="notifBody" placeholder="Complete today's tasks to keep your streak alive!" style="width:100%; padding:12px; border:2px solid #E5E5E5; border-radius:8px; min-height:80px;"></textarea>
            </div>
            <div class="form-group">
                <label>Target Segment</label>
                <select id="notifSegment" style="width:100%; padding:12px; border:2px solid #E5E5E5; border-radius:8px;">
                    <option value="all">All Users</option>
                    <option value="active">Active Users</option>
                    <option value="inactive">Inactive Users</option>
                </select>
            </div>
            <button class="btn" onclick="createNotification()">Send Now</button>
            <button class="btn btn-secondary" onclick="closeModal('createNotificationModal')" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001';
        let adminEmail = '';

        // Login
        async function login() {
            const email = document.getElementById('emailInput').value;

            if (email !== 'kamil.rybialek@gmail.com') {
                showError('loginError', 'Unauthorized email');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    adminEmail = email;
                    localStorage.setItem('adminEmail', email);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminName').textContent = data.admin.name || email;
                    loadDashboard();
                } else {
                    showError('loginError', data.error);
                }
            } catch (error) {
                showError('loginError', 'Failed to connect to server. Make sure admin API is running.');
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            loadAnalytics();
            loadUsers();
            loadTaskTemplates();
            loadNotifications();
            loadActivityLogs();
        }

        async function loadAnalytics() {
            const response = await fetch(`${API_URL}/api/admin/analytics`, {
                headers: { 'x-admin-email': adminEmail }
            });
            const data = await response.json();

            document.getElementById('statTotalUsers').textContent = data.totalUsers;
            document.getElementById('statActiveUsers').textContent = data.activeUsers;
            document.getElementById('statTotalTasks').textContent = data.totalTasks;
            document.getElementById('statCompletionRate').textContent = data.completionRate.toFixed(1) + '%';
        }

        async function loadUsers() {
            const response = await fetch(`${API_URL}/api/admin/users`, {
                headers: { 'x-admin-email': adminEmail }
            });
            const data = await response.json();

            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = data.users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.email}</td>
                    <td><span class="badge badge-info">${u.level || 1}</span></td>
                    <td>${u.total_xp || 0} XP</td>
                    <td>üí∞${u.finance_streak || 0} üß†${u.mental_streak || 0} üí™${u.physical_streak || 0} ü•ó${u.nutrition_streak || 0}</td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        async function loadTaskTemplates() {
            const response = await fetch(`${API_URL}/api/admin/task-templates`, {
                headers: { 'x-admin-email': adminEmail }
            });
            const data = await response.json();

            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = data.templates.map(t => `
                <tr>
                    <td><span class="badge badge-info">${t.pillar}</span></td>
                    <td>${t.title}</td>
                    <td>${t.duration_minutes} min</td>
                    <td>${t.xp_reward} XP</td>
                    <td><span class="badge badge-warning">${t.difficulty}</span></td>
                    <td><button onclick="deleteTask(${t.id})" style="color:red;border:none;background:none;cursor:pointer;">Delete</button></td>
                </tr>
            `).join('');
        }

        async function loadNotifications() {
            const response = await fetch(`${API_URL}/api/admin/notifications`, {
                headers: { 'x-admin-email': adminEmail }
            });
            const data = await response.json();

            const tbody = document.getElementById('notificationsTableBody');
            tbody.innerHTML = data.notifications.map(n => `
                <tr>
                    <td>${n.title}</td>
                    <td>${n.target_segment || 'User #' + n.target_user_id}</td>
                    <td><span class="badge badge-${n.status === 'sent' ? 'success' : 'warning'}">${n.status}</span></td>
                    <td>${n.scheduled_at || '-'}</td>
                    <td>${n.sent_at || '-'}</td>
                </tr>
            `).join('');
        }

        async function loadActivityLogs() {
            const response = await fetch(`${API_URL}/api/admin/activity-logs`, {
                headers: { 'x-admin-email': adminEmail }
            });
            const data = await response.json();

            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = data.logs.map(l => `
                <tr>
                    <td>${l.admin_email}</td>
                    <td><span class="badge badge-info">${l.action}</span></td>
                    <td>${l.target_type || '-'} #${l.target_id || '-'}</td>
                    <td>${l.details || '-'}</td>
                    <td>${new Date(l.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // Tab switching
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
        }

        // Modals
        function showCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('active');
        }

        function showCreateNotificationModal() {
            document.getElementById('createNotificationModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        async function createTask() {
            const data = {
                pillar: document.getElementById('taskPillar').value,
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                duration: parseInt(document.getElementById('taskDuration').value),
                xp: parseInt(document.getElementById('taskXP').value),
                difficulty: document.getElementById('taskDifficulty').value
            };

            await fetch(`${API_URL}/api/admin/task-templates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-admin-email': adminEmail
                },
                body: JSON.stringify(data)
            });

            closeModal('createTaskModal');
            loadTaskTemplates();
        }

        async function deleteTask(id) {
            if (!confirm('Delete this task template?')) return;

            await fetch(`${API_URL}/api/admin/task-templates/${id}`, {
                method: 'DELETE',
                headers: { 'x-admin-email': adminEmail }
            });

            loadTaskTemplates();
        }

        async function createNotification() {
            const data = {
                title: document.getElementById('notifTitle').value,
                body: document.getElementById('notifBody').value,
                targetSegment: document.getElementById('notifSegment').value
            };

            await fetch(`${API_URL}/api/admin/notifications`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-admin-email': adminEmail
                },
                body: JSON.stringify(data)
            });

            closeModal('createNotificationModal');
            loadNotifications();
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        // Check if already logged in
        window.onload = () => {
            const saved = localStorage.getItem('adminEmail');
            if (saved === 'kamil.rybialek@gmail.com') {
                document.getElementById('emailInput').value = saved;
            }
        };
    </script>
</body>
</html>
